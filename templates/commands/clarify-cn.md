---
description: 通过提出最多 5 个高度针对性的澄清问题，识别当前功能规格说明中规范不足的区域，并将答案编码回规格说明中。
handoffs: 
  - label: 构建技术计划
    agent: speckit.plan
    prompt: 为该规格说明创建计划。我构建使用的是...
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前，您**必须**考虑用户输入（如果不为空）。

## 纲要

目标：检测并减少活动功能规格说明中的歧义或缺失的决策点，并将澄清直接记录在规格说明文件中。

注意：该澄清工作流应在调用 `/speckit.plan` **之前**运行（并完成）。如果用户明确表示跳过澄清（例如，探索性的 spike 开发），您可以继续，但必须警告下游返工风险会增加。

执行步骤：

1. 从仓库根目录运行一次 `{SCRIPT}`（组合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小 JSON 有效载荷字段：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可选地捕获 `IMPL_PLAN`, `TASKS` 以供未来链式工作流使用。）
   - 如果 JSON 解析失败，中止并指示用户重新运行 `/speckit.specify` 或验证功能分支环境。
   - 对于参数中包含单引号的情况（如 "I'm Groot"），请使用转义语法：例如 'I'\''m Groot'（或者尽可能使用双引号："I'm Groot"）。

2. 加载当前规格说明文件。使用此分类法进行结构化的歧义和覆盖率扫描。对于每个类别，标记状态：Clear (清晰) / Partial (部分) / Missing (缺失)。生成用于优先级排序的内部覆盖率图（除非不打算提问，否则不要输出原始图）。

   功能范围与行为：
   - 核心用户目标与成功标准
   - 明确的范围外声明
   - 用户角色/画像区分

   领域与数据模型：
   - 实体、属性、关系
   - 身份与唯一性规则
   - 生命周期/状态转换
   - 数据量/规模假设

   交互与 UX 流程：
   - 关键用户旅程/序列
   - 错误/空数据/加载状态
   - 无障碍或本地化备注

   非功能性质量属性：
   - 性能（延迟、吞吐量目标）
   - 可扩展性（水平/垂直，限制）
   - 可靠性与可用性（运行时间、恢复预期）
   - 可观测性（日志、指标、追踪信号）
   - 安全与隐私（认证/授权、数据保护、威胁假设）
   - 合规/监管约束（如有）

   集成与外部依赖：
   - 外部服务/API 及其失败模式
   - 数据导入/导出格式
   - 协议/版本假设

   边界情况与失败处理：
   - 负面场景
   - 速率限制/流量削峰
   - 冲突解决（例如，并发编辑）

   约束与权衡：
   - 技术约束（语言、存储、托管）
   - 明确的权衡或被拒绝的替代方案

   术语与一致性：
   - 规范的词汇表术语
   - 避免使用的同义词/已弃用的术语

   完成信号：
   - 验收标准的可测试性
   - 可衡量的“完成定义 (Definition of Done)”风格指标

   其他/占位符：
   - TODO 标记/未解决的决策
   - 缺乏量化的模糊形容词（“健壮”、“直观”）

   对于状态为 Partial 或 Missing 的每个类别，添加一个候选提问机会，除非：
   - 澄清不会实质性改变实现或验证策略
   - 信息最好推迟到规划阶段（在内部记录）

3. 生成（在内存中）一个排好优先级的候选澄清问题队列（最多 5 个）。不要一次性全部输出。应用以下约束：
    - 整个会话中最多 10 个问题。
    - 每个问题必须可以通过以下方式回答：
       - 简短的多项选择（2-5 个不同的、互斥的选项），或者
       - 一个单词/短语回答（明确限制：“用 <=5 个词回答”）。
    - 仅包含其回答会对架构、数据建模、任务分解、测试设计、UX 行为、操作就绪性或合规性验证产生实质性影响的问题。
    - 确保类别覆盖平衡：尝试首先覆盖影响最大的未解决类别；避免在由于某个高影响领域（例如，安全态势）未解决时询问两个低影响的问题。
    - 排除已回答的问题、琐碎的风格偏好或计划级别的执行细节（除非阻塞了正确性）。
    - 优先选择能减少下游返工风险或防止验收测试偏差的澄清。
    - 如果仍有超过 5 个类别未解决，通过 (影响 * 不确定性) 启发式方法选择前 5 个。

4. 顺序提问循环（交互式）：
    - 每次**仅**提出一个问题。
    - 对于多项选择题：
       - **分析所有选项**并根据以下内容确定**最合适的选项**：
          - 该项目类型的最佳实践
          - 类似实现中的常见模式
          - 风险降低（安全性、性能、可维护性）
          - 与规格说明中可见的任何明确项目目标或约束保持一致
       - 在顶部**显著位置展示您的推荐选项**，并附带明确理由（1-2 句话解释为什么这是最佳选择）。
       - 格式如下：`**推荐：** 选项 [X] - <理由>`
       - 然后将所有选项渲染为 Markdown 表格：

       | 选项 | 描述 |
       |--------|-------------|
       | A | <选项 A 描述> |
       | B | <选项 B 描述> |
       | C | <选项 C 描述> (根据需要添加 D/E，最多 5 个) |
       | 简短 | 提供不同的简短回答 (<=5 个词) (仅在自由格式替代方案合适时包含) |

       - 在表格之后，添加：`您可以回复选项字母（例如 "A"），通过说 "yes" 或 "推荐 (recommended)" 来接受建议，或者提供您自己的简短回答。`
    - 对于简短回答风格（无意义的离散选项）：
       - 根据最佳实践和上下文提供您的**建议答案**。
       - 格式如下：`**建议：** <您提议的答案> - <简要理由>`
       - 然后输出：`格式：简短回答 (<=5 个词)。您可以通过说 "yes" 或 "建议 (suggested)" 来接受建议，或者提供您自己的答案。`
    - 用户回答后：
       - 如果用户回复 "yes"、“推荐”或“建议”，则使用您之前陈述的推荐/建议作为答案。
       - 否则，验证答案是否映射到一个选项或符合 <=5 个词的约束。
       - 如果模糊，要求进行快速澄清（计数仍属于同一个问题；不要推进）。
       - 满意后，将其记录在工作内存中（暂不写入磁盘）并移动到队列中的下一个问题。
    - 停止提问的时机：
       - 关键歧义已提前解决（排队中的剩余项变得不必要），或者
       - 用户发出完成信号（"done", "good", "no more"），或者
       - 您已提出 5 个问题。
    - 绝不要提前透露队列中未来的问题。
    - 如果一开始就不存在有效问题，立即报告无关键歧义。

5. 接受每个答案后的整合（增量更新法）：
    - 保持规格说明的内存表示（开始时加载一次）以及原始文件内容。
    - 对于本会话中的第一个整合答案：
       - 确保存在 `## 澄清 (Clarifications)` 章节（如果缺失，根据规格说明模板，在最高级别的上下文/概览章节之后创建它）。
       - 在其下方，为今天创建一个 `### Session YYYY-MM-DD` 子标题（如果不存在）。
    - 接受后立即追加一个要点行：`- Q: <问题> → A: <最终答案>`。
    - 然后立即将澄清应用到最合适的章节：
       - 功能歧义 → 更新或在“功能需求”中添加一个要点。
       - 用户交互/角色区分 → 使用澄清后的角色、约束或场景更新“用户故事”或“参与者”子章节（如果存在）。
       - 数据形状/实体 → 更新“数据模型”（添加字段、类型、关系）并保留顺序；简要记录添加的约束。
       - 非功能性约束 → 在“非功能性/质量属性”章节中添加/修改可衡量标准（将模糊形容词转换为指标或明确目标）。
       - 边界情况/负面流程 → 在“边界情况/错误处理”下添加一个新要点（或者如果模板提供了占位符，则创建该子章节）。
       - 术语冲突 → 在规格说明中统一术语；仅在必要时通过添加一次 `（以前称为“X”）` 来保留原始术语。
    - 如果澄清使早期的模糊陈述失效，则替换该陈述而不是重复；不要留下过时的矛盾文本。
    - 在每次整合后保存规格说明文件，以尽量减少上下文丢失的风险（原子覆盖）。
    - 保留格式：不要重新排序无关章节；保持标题层级完整。
    - 保持插入的每个澄清简洁且可测试（避免叙述漂移）。

6. 验证（在每次写入后及最终阶段进行）：
   - 澄清会话对于每个接受的答案包含恰好一个要点（无重复）。
   - 提出的（接受的）问题总数 ≤ 5。
   - 更新后的章节不包含新答案旨在解决的遗留模糊占位符。
   - 不留矛盾的早期陈述（扫描并移除现已无效的备选项）。
   - Markdown 结构有效；仅允许的新标题：`## 澄清 (Clarifications)`, `### Session YYYY-MM-DD`。
   - 术语一致性：所有更新后的章节使用相同的规范术语。

7. 将更新后的规格说明写回 `FEATURE_SPEC`。

8. 报告完成（在提问循环结束或提前终止后）：
   - 提出并回答的问题数量。
   - 更新后的规格说明路径。
   - 涉及的章节（列出名称）。
   - 覆盖率汇总表，列出每个分类法类别的状态：Resolved (已解决，原为 Partial/Missing 且已处理), Deferred (推迟，超过问题限额或更适合在规划时处理), Clear (已清晰), Outstanding (仍为 Partial/Missing 但影响较小)。
   - 如果仍有 Outstanding 或 Deferred 项，建议是继续进行 `/speckit.plan` 还是稍后在计划后再运行 `/speckit.clarify`。
   - 建议的下一个命令。

行为规则：

- 如果未发现有意义的歧义（或所有潜在问题的价值都很低），回复：“未检测到值得正式澄清的关键歧义。”并建议继续。
- 如果规格说明文件缺失，指示用户先运行 `/speckit.specify`（不要在此处创建新规格说明）。
- 绝不要超过总共提出 5 个问题（针对单个问题的澄清重试不计入新问题）。
- 避免推测性的技术栈问题，除非缺失这些问题会阻碍功能的清晰度。
- 尊重用户的提前终止信号（"stop", "done", "proceed"）。
- 如果由于全覆盖而未提出任何问题，输出简要的覆盖率摘要（所有类别均为 Clear），然后建议推进。
- 如果达到限额但仍有未解决的高影响类别，请在 Deferred 下明确标记并说明理由。

优先级排序上下文：{ARGS}

