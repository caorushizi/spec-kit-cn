---
description: 在生成任务后，对 spec.md, plan.md 和 tasks.md 进行非破坏性的跨产物一致性和质量分析。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前，您**必须**考虑用户输入（如果不为空）。

## 目标

在实现之前，识别核心产物（`spec.md`, `plan.md`, `tasks.md`）之间的一致性、重复、模糊和规范不足的项。此命令**必须**仅在 `/speckit.tasks` 成功生成完整的 `tasks.md` 之后运行。

## 操作约束

**严格只读**：**不要**修改任何文件。输出一份结构化的分析报告。提供一个可选的修复计划（在调用任何后续的手动编辑命令之前，用户必须明确批准）。

**宪法权威**：项目宪法 (`/memory/constitution.md`) 在此分析范围内是**不可协商的**。宪法的冲突自动被视为“关键 (CRITICAL)”级别，并要求调整规格说明、计划或任务 —— 而不是稀释、重新解释或无视该原则。如果原则本身需要更改，则必须在 `/speckit.analyze` 之外通过单独的、明确的宪法更新来进行。

## 执行步骤

### 1. 初始化分析上下文

从仓库根目录运行一次 `{SCRIPT}`，并解析 FEATURE_DIR 和 AVAILABLE_DOCS 的 JSON。推导绝对路径：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

如果缺少任何必需的文件，则中止并显示错误消息（指示用户运行缺少的前提命令）。
对于参数中包含单引号的情况（如 "I'm Groot"），请使用转义语法：例如 'I'\''m Groot'（或者尽可能使用双引号:"I'm Groot"）。

### 2. 加载产物（渐进式披露）

从每个产物中仅加载最必要的上下文：

**来自 spec.md：**

- 概览/上下文
- 功能需求
- 非功能需求
- 用户故事
- 边界情况（如果存在）

**来自 plan.md：**

- 架构/技术栈选择
- 数据模型引用
- 阶段
- 技术约束

**来自 tasks.md：**

- 任务 ID
- 描述
- 阶段分组
- 并行标记 [P]
- 引用的文件路径

**来自宪法：**

- 加载 `/memory/constitution.md` 进行原则验证

### 3. 构建语义模型

创建内部表示（不要在输出中包含原始产物）：

- **需求清单**：具有稳定键的每个功能 + 非功能需求（根据命令式短语推导标识符；例如，“用户可以上传文件” → `user-can-upload-file`）
- **用户故事/操作清单**：具有验收标准的离散用户操作
- **任务覆盖率映射**：将每个任务映射到一个或多个需求或故事（通过关键字/显式引用模式，如 ID 或关键短语进行推断）
- **宪法规则集**：提取原则名称和 MUST/SHOULD 规范性陈述

### 4. 检测 pass (令牌高效分析)

专注于高信号的发现。总共限制在 50 条发现以内；其余部分汇总在溢出摘要中。

#### A. 重复检测

- 识别近乎重复的需求
- 标记质量较低的表述以进行合并

#### B. 模糊性检测

- 标记缺乏可衡量标准的模糊形容词（快速、可扩展、安全、直观、健壮）
- 标记未解决的占位符（TODO, TKTK, ???, `<placeholder>` 等）

#### C. 规范不足

- 有动词但缺少对象或可衡量结果的需求
- 验收标准未对齐的用户故事
- 任务引用的文件或组件在规格说明/计划中未定义

#### D. 宪法一致性

- 任何与 MUST 原则冲突的需求或计划元素
- 缺少宪法强制要求的章节或质量门禁

#### E. 覆盖缺口

- 没有任何关联任务的需求
- 没有映射到需求/故事的任务
- 任务中未反映的非功能需求（例如性能、安全性）

#### F. 不一致性

- 术语漂移（不同文件中对同一概念命名不同）
- 计划中引用但在规格说明中缺失的数据实体（反之亦然）
- 任务顺序矛盾（例如，在没有依赖注释的情况下，集成任务在基础设置任务之前）
- 冲突的需求（例如，一个要求使用 Next.js，而另一个指定使用 Vue）

### 5. 严重性分配

使用此启发式方法对发现进行优先级排序：

- **关键 (CRITICAL)**：违反了宪法的 MUST 原则，缺少核心规格说明产物，或具有阻塞基准功能的零覆盖率需求
- **高 (HIGH)**：重复或冲突的需求，模糊的安全/性能属性，不可测试的验收标准
- **中 (MEDIUM)**：术语漂移，缺少非功能任务覆盖，规范不足的边界情况
- **低 (LOW)**：风格/词语改进，不影响执行顺序的轻微冗余

### 6. 生成紧凑的分析报告

输出一个 Markdown 报告（不写入文件），结构如下：

## 规格说明分析报告

| ID | 类别 | 严重性 | 位置 | 摘要 | 建议 |
|----|----------|----------|-------------|---------|----------------|
| A1 | 重复 | 高 | spec.md:L120-134 | 两个类似的需求 ... | 合并表述；保留更清晰的版本 |

（每条发现一行；生成以类别首字母为前缀的稳定 ID。）

**覆盖率汇总表：**

| 需求键 (Requirement Key) | 是否有任务？ | 任务 ID | 备注 |
|-----------------|-----------|----------|-------|

**宪法对齐问题：**（如果有）

**未映射的任务：**（如果有）

**指标：**

- 总需求数
- 总任务数
- 覆盖率 %（具有 >=1 个任务的需求）
- 模糊项计数
- 重复项计数
- 关键问题计数

### 7. 提供后续行动

在报告末尾，输出一个简明扼要的“后续行动”区块：

- 如果存在“关键 (CRITICAL)”问题：建议在 `/speckit.implement` 之前解决
- 如果仅有“低/中”问题：用户可以继续，但提供改进建议
- 提供明确的命令建议：例如，“运行 /speckit.specify 进行精炼”，“运行 /speckit.plan 调整架构”，“手动编辑 tasks.md 以添加对 '性能指标' 的覆盖”

### 8. 提供修复建议

询问用户：“您是否希望我为前 N 个问题提供具体的修复编辑建议？”（不要自动应用它们。）

## 操作原则

### 上下文效率

- **最小的高信号令牌**：专注于可操作的发现，而不是详尽的文档
- **渐进式披露**：增量加载产物；不要将所有内容转储到分析中
- **令牌高效输出**：发现表限制在 50 行以内；对溢出内容进行汇总
- **确定性结果**：在没有更改的情况下重新运行应产生一致的 ID 和计数

### 分析指南

- **绝不修改文件**（这是只读分析）
- **绝不幻想缺失的章节**（如果缺失，请如实报告）
- **优先处理违反宪法的情况**（这些始终是关键问题）
- **使用示例而非详尽的规则**（引用特定实例，而非通用模式）
- **优雅地报告零问题**（发出带有覆盖率统计的成功报告）

## 上下文

{ARGS}

